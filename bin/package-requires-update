#!/usr/bin/env node

var exec = require( 'child-process-promise' ).exec;
var packageJson;
var semver = require( 'semver' );
var validatePackageName = require( 'validate-npm-package-name' );

if ( !process.argv[2] ) {
	console.log( 'This script requires that you provide arguments' );
}

try {
	packageJson = require( '../' + process.argv[2] );
} catch ( e ) {
	console.log( 'Failure: ', e );
}

if ( packageJson.private ) {
	process.exitCode = 0;
}

if ( !validatePackageName( packageJson.name ) ) {
	console.log( 'Package name contains spaces and/or invalid characters: ', packageJson.name );
} else {
	exec( 'npm view ' + packageJson.name + ' version' )
		.then( function( result ) {
			if ( !semver.valid( packageJson.version ) ) {
				console.log( 'Package version is not valid semver: ', packageJson.name );
			} else if ( semver.gt( packageJson.version, result.stdout ) ) {
				process.exitCode = 0;
			} else {
				console.log( packageJson.name, 'Package must be versioned' );
				console.log( '\n' );
				process.exitCode = 1;
			}
		} );
}
